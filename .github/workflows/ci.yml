name: CI

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Cox StackShift
    runs-on: CAI-Enterprise

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify plugin structure
        run: |
          echo "✅ Validating Cox StackShift plugin structure..."

          # Check required plugin files exist
          if [ ! -f "plugin/.claude-plugin/plugin.json" ]; then
            echo "❌ Missing plugin.json"
            exit 1
          fi

          # Check skills exist
          if [ ! -d "plugin/skills" ]; then
            echo "❌ Missing skills directory"
            exit 1
          fi

          # Check core skills
          for skill in analyze reverse-engineer create-specs gap-analysis complete-spec implement modernize cruise-control; do
            if [ ! -f "plugin/skills/${skill}/SKILL.md" ]; then
              echo "❌ Missing skill: ${skill}"
              exit 1
            fi
            echo "✅ Found skill: ${skill}"
          done

          echo "✅ Plugin structure validated"

      - name: Verify Cox customizations
        run: |
          echo "✅ Checking Cox-specific customizations..."

          # Verify mcp-server is removed
          if [ -d "mcp-server" ]; then
            echo "❌ mcp-server should be removed in Cox version"
            exit 1
          fi
          echo "✅ mcp-server correctly removed"

          # Verify Osiris docs exist
          if [ ! -f "docs/osiris/ws-scripts-capabilities.md" ]; then
            echo "❌ Missing Osiris documentation"
            exit 1
          fi
          echo "✅ Osiris documentation present"

          # Verify Cox README sections exist
          if ! grep -q "Why This Matters at Cox Automotive" README.md; then
            echo "❌ Missing Cox Automotive section in README"
            exit 1
          fi
          echo "✅ Cox README customizations present"

          echo "✅ Cox customizations validated"

      - name: Verify automation
        run: |
          echo "✅ Checking automation tools..."

          # Check GitHub Action exists
          if [ ! -f ".github/workflows/sync-upstream.yml" ]; then
            echo "❌ Missing sync-upstream workflow"
            exit 1
          fi
          echo "✅ Upstream sync workflow present"

          # Check manual script exists and is executable
          if [ ! -x "scripts/cox-automation/sync-upstream.sh" ]; then
            echo "❌ Missing or non-executable sync script"
            exit 1
          fi
          echo "✅ Manual sync script present and executable"

          echo "✅ Automation validated"

      - name: Validate plugin.json
        run: |
          echo "✅ Validating plugin.json structure..."

          # Check if jq is available (it should be on most runners)
          if command -v jq &> /dev/null; then
            cat plugin/.claude-plugin/plugin.json | jq empty && echo "✅ Valid JSON"
          else
            echo "⚠️ jq not available, skipping JSON validation"
          fi

      - name: Check slash commands
        run: |
          echo "✅ Checking slash commands..."

          # Count slash commands
          COMMAND_COUNT=$(find .claude/commands -name "*.md" -type f 2>/dev/null | wc -l || echo "0")
          echo "Found ${COMMAND_COUNT} slash commands"

          if [ "$COMMAND_COUNT" -gt "0" ]; then
            echo "✅ Slash commands present"
          else
            echo "⚠️ No slash commands found (optional)"
          fi

      - name: Summary
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Cox StackShift Validation Complete"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "All checks passed!"
          echo "- Plugin structure valid"
          echo "- Cox customizations intact"
          echo "- Automation tools configured"
          echo ""
