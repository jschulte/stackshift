# StackShift Specification Alignment Check
#
# This workflow validates that specifications stay aligned with implementation.
# Run on PRs to catch spec drift before merging.
#
# Usage:
# 1. Copy this file to your repository's .github/workflows/ directory
# 2. Customize the configuration below
# 3. PRs will automatically be checked for spec alignment

name: Spec Alignment

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'app/**'
      - '.specify/**'
      - 'specs/**'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      fail_on_drift:
        description: 'Fail if spec drift detected'
        required: false
        default: 'true'

jobs:
  spec-quality:
    name: Spec Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install StackShift MCP
        run: npm install -g stackshift-mcp

      - name: Check spec quality
        id: quality
        run: |
          # Run spec quality analysis
          stackshift-mcp spec-quality --directory . --format json > quality-report.json

          # Extract overall score
          SCORE=$(jq '.overallScore' quality-report.json)
          echo "score=$SCORE" >> $GITHUB_OUTPUT

          # Check for errors
          ERRORS=$(jq '.issueSummary.errors' quality-report.json)
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

          # Generate markdown summary
          stackshift-mcp spec-quality --directory . --format markdown > quality-report.md

      - name: Post quality report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');
            const score = ${{ steps.quality.outputs.score }};

            const icon = score >= 80 ? '‚úÖ' : score >= 60 ? '‚ö†Ô∏è' : '‚ùå';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ${icon} Spec Quality Report\n\n**Score: ${score}/100**\n\n<details>\n<summary>View Full Report</summary>\n\n${report}\n\n</details>`
            });

      - name: Check quality threshold
        if: steps.quality.outputs.score < 60 || steps.quality.outputs.errors > 0
        run: |
          echo "‚ùå Spec quality below threshold!"
          echo "Score: ${{ steps.quality.outputs.score }}/100 (minimum: 60)"
          echo "Errors: ${{ steps.quality.outputs.errors }}"
          exit 1

  spec-drift:
    name: Spec Drift Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          path: pr-branch

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base-branch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install StackShift MCP
        run: npm install -g stackshift-mcp

      - name: Compare specs
        id: diff
        run: |
          # Run spec diff
          stackshift-mcp spec-diff \
            --base-directory base-branch \
            --compare-directory pr-branch \
            --format json > diff-report.json

          # Extract counts
          ADDED=$(jq '.added' diff-report.json)
          REMOVED=$(jq '.removed' diff-report.json)
          MODIFIED=$(jq '.modified' diff-report.json)

          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "removed=$REMOVED" >> $GITHUB_OUTPUT
          echo "modified=$MODIFIED" >> $GITHUB_OUTPUT

          # Generate markdown
          stackshift-mcp spec-diff \
            --base-directory base-branch \
            --compare-directory pr-branch \
            --format markdown > diff-report.md

      - name: Post diff report
        if: steps.diff.outputs.added > 0 || steps.diff.outputs.removed > 0 || steps.diff.outputs.modified > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('diff-report.md', 'utf8');

            const added = ${{ steps.diff.outputs.added }};
            const removed = ${{ steps.diff.outputs.removed }};
            const modified = ${{ steps.diff.outputs.modified }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## üìã Spec Changes Detected\n\n| Change | Count |\n|--------|-------|\n| ‚ûï Added | ${added} |\n| ‚ûñ Removed | ${removed} |\n| üìù Modified | ${modified} |\n\n<details>\n<summary>View Full Diff</summary>\n\n${report}\n\n</details>`
            });

      - name: Check for removed specs
        if: steps.diff.outputs.removed > 0 && github.event.inputs.fail_on_drift != 'false'
        run: |
          echo "‚ö†Ô∏è Specifications were removed in this PR!"
          echo "Removed: ${{ steps.diff.outputs.removed }}"
          echo "Please ensure this is intentional and update related code."
          # Uncomment to fail on removed specs:
          # exit 1

  validate-implementation:
    name: Validate Spec-Code Alignment
    runs-on: ubuntu-latest
    needs: [spec-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check for spec markers in code
        run: |
          # Find any [NEEDS CLARIFICATION] or TODO markers that should be resolved
          MARKERS=$(grep -r "\[NEEDS CLARIFICATION\]\|TODO.*spec\|FIXME.*spec" --include="*.ts" --include="*.js" --include="*.md" . || true)

          if [ -n "$MARKERS" ]; then
            echo "‚ö†Ô∏è Found unresolved spec markers:"
            echo "$MARKERS"
            echo ""
            echo "Consider resolving these before merging."
          fi

      - name: Summary
        run: |
          echo "## ‚úÖ Spec Alignment Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All specification checks passed!" >> $GITHUB_STEP_SUMMARY
